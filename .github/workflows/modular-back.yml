name: modular backend
run-name: ${{ github.actor }} started GitHub Actions üöÄ
on:
  push:
    branches: [ "main", "develop", "fix/CICD" ]
    paths-ignore:
      - 'pyproject.toml'
  pull_request:
    branches: [ "main", "develop" ]
  workflow_dispatch:

env:
  MODULAR_BACK_VERSION: 1.0.1
  POETRY_VERSION: "1.8.2"
  PYTHON_VERSION: "3.12"
  REGISTRY: ghcr.io

jobs:

  # test:
  #   name: Linters and Pytests
  #   runs-on: ubuntu-latest
  #   strategy:
  #     matrix:
  #       python-version: [3.12]
  #   steps:
  #   - uses: actions/checkout@v4
  #   -
  #     name: Set up Python
  #     uses: actions/setup-python@v5
  #     with:
  #       python-version: ${{ matrix.python-version }}
  #   - uses: isort/isort-action@v1
  #   - uses: Gr1N/setup-poetry@v8
  #   -
  #     uses: actions/cache@v4
  #     with:
  #       path: ~/.cache/pypoetry/virtualenvs
  #       key: ${{ runner.os }}-poetry-${{ hashFiles('poetry.lock') }}
  #   -
  #     name: Install dependencies
  #     run: poetry install
  #   -
  #     name: Format with black
  #     run: |
  #       poetry run black --check .
  #       python bot_constructor/manage.py test

  # build:
  #   name: Push Docker image to Docker Hub
  #   runs-on: ubuntu-latest
  #   # needs: test
  #   # if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/production'
  #   # if: github.ref == 'refs/heads/develop'
  #   steps:
  #     - name: Check out the repo
  #       uses: actions/checkout@v4
  #     - name: Set up Docker Buildx
  #       uses: docker/setup-buildx-action@v3
  #     - name: Login to Docker
  #       uses: docker/login-action@v3
  #       with:
  #         username: ${{ secrets.DOCKERHUB_USERNAME }}
  #         password: ${{ secrets.DOCKERHUB_TOKEN }}
  #     - name: Push to Docker Hub
  #       uses: docker/build-push-action@v5
  #       with:
  #         file: bot_constructor/Dockerfile
  #         push: true
  #         tags: |
  #           ${{ secrets.DOCKERHUB_USERNAME }}/${{ vars.BACKEND_IMAGE_NAME}}:latest
  #           ${{ secrets.DOCKERHUB_USERNAME }}/${{ vars.BACKEND_IMAGE_NAME}}:${{ env.MODULAR_BACK_VERSION }}

  # deploy:
  #   name: Deployment on remote server
  #   runs-on: ubuntu-latest
  #   needs: build
  #   steps:
  #     - name: executing remote ssh commands using password
  #       uses: appleboy/ssh-action@v1.0.0
  #       with:
  #         host: ${{ secrets.MODULAR_HOST }}
  #         username: ${{ secrets.HOST_USER }}
  #         # password: ${{ secrets.HOST_USER_PWD }}
  #         key: ${{ secrets.HOST_SSH_KEY }}
  #         script: |
  #           docker stop ${{ vars.BACKEND_CONTAINER_NAME }}
  #           docker rm ${{ vars.BACKEND_CONTAINER_NAME }}
  #           docker rmi ${{ secrets.DOCKERHUB_USERNAME }}/${{ vars.BACKEND_IMAGE_NAME }}:latest
  #           docker pull ${{ secrets.DOCKERHUB_USERNAME }}/${{ vars.BACKEND_IMAGE_NAME }}:latest
  #           docker run -d \
  #             --name=${{ vars.BACKEND_CONTAINER_NAME }} \
  #             --hostname=${{ vars.BACKEND_CONTAINER_NAME }} \
  #             --net=${{ secrets.MODULAR_NETWORK_NAME }} \
  #             --restart=unless-stopped \
  #             -v static_value:/app/static/ \
  #             -v media_value:/app/media/ \
  #             ${{ secrets.DOCKERHUB_USERNAME }}/${{ vars.BACKEND_IMAGE_NAME }}:latest

  notify:
    runs-on: ubuntu-latest
    # needs: deploy
    steps:
      - name: Send Telegram Message
        run: |
          tg_nick=${{ vars.GH_BACK_TEAM }}[${{github.actor}}]
          message='‚ú® Hey there! ‚ú®
            –†–∞–±–æ—á–∏–π –ø–æ—Ç–æ–∫ ${{ github.workflow }} —É—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω!
            –°–æ–±—ã—Ç–∏–µ: üöÄ ${{ github.event_name }}
            –ê–≤—Ç–æ—Ä: üêß ${{ github.actor }} (@${tg_nick})
            –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π: üéâ ${{ github.repository }}
            –í–µ—Ç–∫–∞: üîé ${{ github.ref_name }}
            Sincerely yours, ‚ú® Xwick Bot ‚ú®'
          curl -s -X POST 'https://api.telegram.org/bot${{ secrets.TG_BOT_TOKEN }}/sendMessage' \
            -d "chat_id=${{ secrets.TG_CHAT_ID }}&text=${message}"
        # -d "chat_id=-${{ secrets.TG_CHAT_ID }}&message_thread_id=${{ vars.TG_BACK_THREAD_ID }}&text=${message}"
